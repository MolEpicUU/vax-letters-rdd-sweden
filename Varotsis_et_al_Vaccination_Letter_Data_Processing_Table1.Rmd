---
title: "Effect of COVID-19 Vaccination Appointment Letters on Uptake by Sociodemographic Characteristics: A Regression Discontinuity Analysis in Sweden, December 2020 to September 2021. Georgios Varotsis, MSc, Ulf Hammar, BSc, Carl Bonander, PhD, Per Lundmark, PhD, Beatrice Kennedy, PhD, Maria F. Gomez, MD, Mats Martinell, MD, Oliver J. Dyar, MD, Anna Sarkadi, MD, Robert Kristiansson, MD, Helena Svaleryd, PhD, Tove Fall, PhD"
subtitle: "Data Processing and Table 1"

author: "Georgios Varotsis, MSc"
created: "2023-11-29" 
last updated: "2025-05-28"
output: 
  html_document:
    theme: cerulean
    toc: true 
    fig_width: 6
    fig_height: 4
    number_sections: TRUE
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 4
    code_folding: hide
    hightlist: espresso
    css: style.cs
    
    
    
---


```{css, echo=FALSE}


body .main-container {
max-width: 1500px !important;
width: 1500px !important;
}
.book .book-body .page-inner {
max-width: 1200px;
margin: 0 auto;
padding: 10px 10px 10px 10px;
}
body {
max-width: 1500px !important;
}
code.r { /* Code block */
font-size: 14pt;
}
pre {
font-size: 12px
}
.tocify-header {
text-indent: initial;
}
.tocify-subheader > .tocify-item {
text-indent: initial;
padding-left: 2em;
}
table.display td { white-space: nowrap; }
```


```{r setup, include=FALSE, message=FALSE, warning=FALSE, tidy = TRUE, error = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)


```



# Variables

## World Bank/Birth Country

Code (click button on the right):
```{r foreign-born-manipulations, warning = FALSE}



library(lmtest)
library(tidyverse)
library(broom)
library(rdrobust)
library(rddensity) 
library(modelsummary) 
library(data.table)
library(rio)

library(survey)
library(rddapp)
library(sandwich)
library(lmtest)
library(splines)
library(epiDisplay)
library(knitr)
library(kableExtra)
library(viridis)
library(scales)
library(rdrobust)
library(rdrobust)
library(splines)
library(epiDisplay)
library(forcats)


pop <-  fread("data.csv")



foreign_swed <- fread('data.csv')
foreign_swed$V1<-NULL

all_unique_countries <- foreign_swed %>%
  distinct(Fodelseland) %>% 
  arrange(Fodelseland)



```

## Length of stay & Risk group & Values

```{r lengthStay-outcome-uppsala, warning=FALSE}



risk_group <-  fread("data.csv")

risk_group <- risk_group %>% 
  dplyr::select(-year) %>% 
  mutate(lopnr = as.character(lopnr)) %>%
  mutate(N_Risk_groups = rowSums(across(where(is.integer))),
         Risk_group = ifelse(N_Risk_groups >= 1, 'Yes', 'No'),
         lopnr = as.numeric(lopnr)) 



risk_group <- risk_group %>% 
  dplyr::select(lopnr, Risk_group)


length_stay <-  fread("data.csv")

length_stay$immigration_date <-  paste0(substr(length_stay$datinv, 1, 4), '-', substr(length_stay$datinv, 5,6),  '-', substr(length_stay$datinv, 7,8))

length_stay$immigration_date <-  as.Date(length_stay$immigration_date,format = '%Y-%m-%d')


length_stay$length_stay_days <- difftime(as.Date('2020-12-31', format = '%Y-%m-%d'), length_stay$immigration_date, units = 'days')
length_stay$length_stay_years <- as.numeric(difftime(as.Date('2020-12-31', format = '%Y-%m-%d'), length_stay$immigration_date, units = 'weeks')/52)


length_stay <- length_stay %>% 
  mutate(length_stay_cat = ifelse(length_stay_years<=10, 'Short','Long')) %>% 
  dplyr::select(P1105_LopNr_PersonNr,length_stay_cat, length_stay_years )


values_country <-  fread("data.txt")

values_country$country_in_data[values_country$country_in_data=='JUNGFRUÃ–ARNA, BRITTISKA'] <- 'JUNGFRUÖARNA, BRITTISKA'
values_country$country_in_data[values_country$country_in_data=='VÃ„STBANKEN OCH GAZA'] <- 'VÄSTBANKEN OCH GAZA'
values_country$country_in_data[values_country$country_in_data=='NEDERLÃ„NDERNA'] <- 'NEDERLÄNDERNA'
values_country$country_in_data[values_country$country_in_data=='Ã–STERRIKE'] <- 'ÖSTERRIKE'
values_country$country_in_data[values_country$country_in_data=='FÃ–RENADE KUNGARIKET'] <- 'FÖRENADE KUNGARIKET'
values_country$country_in_data[values_country$country_in_data=='FÃ–RENTA STATERNA'] <- 'FÖRENTA STATERNA'
values_country$country_in_data[values_country$country_in_data=='RUMÃ„NIEN'] <- 'RUMÄNIEN'
values_country$country_in_data[values_country$country_in_data=='FÃ–RENADE ARABEMIRATEN'] <- 'FÖRENADE ARABEMIRATEN'
values_country$country_in_data[values_country$country_in_data=='MOÃ‡AMBIQUE'] <- 'MOÇAMBIQUE'
values_country$country_in_data[values_country$country_in_data=='SALOMONÃ–ARNA'] <- 'SALOMONÖARNA'
values_country$country_in_data[values_country$country_in_data=='SAO TOME OCH PRINCIPE'] <- 'SALOMONÖARNA'
values_country$country_in_data[values_country$country_in_data=='MARSHALLÃ–ARNA'] <- 'MARSHALLÖARNA'



values_country_mean_median <- values_country %>% 
  group_by(Classification) %>% 
  summarize(md_Trust_per_cluster = median(Dis_Trust_Hofstede_Welzel, na.rm = T),
            mn_Trust_per_cluster = mean(Dis_Trust_Hofstede_Welzel, na.rm = T))


values_country <- values_country %>% 
  left_join(values_country_mean_median, by = 'Classification') %>% 
  mutate(Trust_Hfs_Wlzl = coalesce(Dis_Trust_Hofstede_Welzel, md_Trust_per_cluster)) %>% 
  mutate(mn_Trust_overall = mean(Trust_Hfs_Wlzl, na.rm = T),
         md_Trust_overall = median(Trust_Hfs_Wlzl, na.rm = T))



values_country <- values_country %>% 
  mutate(quantile_group = ntile(Trust_Hfs_Wlzl,2)) %>% 
  mutate(trust_catgr = quantile_group) %>% 
  group_by(trust_catgr) %>% 
  mutate(mean_Trust_p_qntl = mean(Trust_Hfs_Wlzl)) %>% 
  ungroup() #%>% 

values_country$trust_catgr[values_country$English=='Sweden'] <- 'Sweden'
values_country$trust_catgr[values_country$trust_catgr==1] <- 'Low'
values_country$trust_catgr[values_country$trust_catgr==2] <- 'High'

values_country <- values_country %>% 
  dplyr::select(country_in_data, trust_catgr)





```



## Education + Outcome


Uppsala code (click button on the right):
```{r education-outcome-uppsala, warning=FALSE}

library(data.table)



ind_2020 <-  fread("data.csv")



ind_2020_uppsala <- ind_2020 %>% 
  filter(Lan == 3)


population_uppsala <- length(unique(ind_2020_uppsala$P1105_LopNr_PersonNr))


main_data_uppsala <- ind_2020_uppsala %>% 
  dplyr::select(P1105_LopNr_PersonNr,DispInk04 ,DispInkFam04, Lan, Civil, Ssyk4_2012_J16 , Sun2020niva_old) %>% 
  mutate( Sun_name_catg = case_when(
    Sun2020niva_old == 0 | Sun2020niva_old == 1 |Sun2020niva_old == 2 ~ 'Primary School',
    Sun2020niva_old == 3 | Sun2020niva_old == 4 ~ 'Gymnasium',
    Sun2020niva_old == 5 | Sun2020niva_old == 6 |Sun2020niva_old == 7 ~ 'University',
    TRUE ~ NA
  ))



# LOAD
fhm_nvr <-  fread("data.csv")
fhm_nvr$V1 <- NULL

gdb_2020 <-  fread("data.csv")


gdb_2020 <- data.table(gdb_2020, key = 'P1105_Lopnr_PersonNr')
gdb_2020 <- gdb_2020[, .SD[1], by =P1105_Lopnr_PersonNr]


main_data_uppsala <- main_data_uppsala %>% 
  dplyr::left_join(fhm_nvr %>%  
                     distinct( P1105_LopNr_PersonNr, First_dose)) %>% 
  dplyr::left_join((pop %>%  
                      dplyr::select(P1105_LopNr_PersonNr, FodelseArMan, Kon) %>% 
                      distinct(P1105_LopNr_PersonNr, FodelseArMan, Kon))) %>% 
  dplyr::left_join(gdb_2020 %>% 
                     rename(P1105_LopNr_PersonNr = P1105_Lopnr_PersonNr) %>%
                     distinct(P1105_LopNr_PersonNr, DeSO)) 


main_data_uppsala <- main_data_uppsala %>% 
  dplyr::left_join(foreign_swed)# %>% 


main_data_uppsala <- main_data_uppsala %>% 
  dplyr::left_join(values_country, by = c('Country_name_SV' = 'country_in_data')) %>% 
  dplyr::left_join(risk_group, by = c('P1105_LopNr_PersonNr' = 'lopnr')) %>% 
  dplyr::left_join(length_stay, by = 'P1105_LopNr_PersonNr')



main_data_uppsala$length_stay_cat[main_data_uppsala$Country_name_SV == 'SVERIGE'] <- 'Born in Sweden'

main_data_uppsala$Risk_group[is.na(main_data_uppsala$Risk_group)] <- 'No'



```



Gävle code (click button on the right):
```{r education-outcome-gavle, warning = FALSE}




ind_2020_gavle <- ind_2020 %>% 
  filter(Lan == 21)

main_data_gavle <- ind_2020_gavle %>% 
  dplyr::select(P1105_LopNr_PersonNr,DispInk04 ,DispInkFam04, Lan, Civil, Ssyk4_2012_J16 , Sun2020niva_old) %>% 
  mutate( Sun_name_catg = case_when(
    Sun2020niva_old == 0 | Sun2020niva_old == 1 |Sun2020niva_old == 2 ~ 'Primary School',
    Sun2020niva_old == 3 | Sun2020niva_old == 4 ~ 'Gymnasium',
    Sun2020niva_old == 5 | Sun2020niva_old == 6 |Sun2020niva_old == 7 ~ 'University',
    TRUE ~ NA
  ))#

main_data_gavle <- main_data_gavle %>% 
  dplyr::left_join(fhm_nvr %>%  
                     distinct( P1105_LopNr_PersonNr, First_dose)) %>% 
  dplyr::left_join((pop %>%  
                      dplyr::select(P1105_LopNr_PersonNr, FodelseArMan, Kon) %>% 
                      distinct(P1105_LopNr_PersonNr, FodelseArMan, Kon))) %>% 
  dplyr::left_join(gdb_2020 %>% 
                     rename(P1105_LopNr_PersonNr = P1105_Lopnr_PersonNr) %>%
                     distinct(P1105_LopNr_PersonNr, DeSO)) 


main_data_gavle <- main_data_gavle %>% 
  dplyr::left_join(foreign_swed) %>% 
  distinct(P1105_LopNr_PersonNr, .keep_all = T )

main_data_gavle <- main_data_gavle %>% 
  dplyr::left_join(values_country, by = c('Country_name_SV' = 'country_in_data')) %>% 
  dplyr::left_join(risk_group, by = c('P1105_LopNr_PersonNr' = 'lopnr')) %>% 
  dplyr::left_join(length_stay, by = 'P1105_LopNr_PersonNr')


main_data_gavle$length_stay_cat[main_data_gavle$Country_name_SV == 'SVERIGE'] <- 'Born in Sweden'

main_data_gavle$Risk_group[is.na(main_data_gavle$Risk_group)] <- 'No'



```


Stockholn code (click button on the right):
```{r education-outcome-stockholm, warning = FALSE}






ind_2020_stockholm <- ind_2020 %>% 
  filter(Lan == 1)


main_data_stockholm <- ind_2020_stockholm %>% 
  dplyr::select(P1105_LopNr_PersonNr,DispInk04 ,DispInkFam04, Lan, Civil, Ssyk4_2012_J16 , Sun2020niva_old) %>% 
  mutate( Sun_name_catg = case_when(
    Sun2020niva_old == 0 | Sun2020niva_old == 1 |Sun2020niva_old == 2 ~ 'Primary School',
    Sun2020niva_old == 3 | Sun2020niva_old == 4 ~ 'Gymnasium',
    Sun2020niva_old == 5 | Sun2020niva_old == 6 |Sun2020niva_old == 7 ~ 'University',
    TRUE ~ NA
  ))


main_data_stockholm <- main_data_stockholm %>% 
  dplyr::left_join(fhm_nvr %>%  
                     distinct( P1105_LopNr_PersonNr, First_dose)) %>% 
  dplyr::left_join((pop %>%  
                      dplyr::select(P1105_LopNr_PersonNr, FodelseArMan, Kon) %>% 
                      distinct(P1105_LopNr_PersonNr, FodelseArMan, Kon))) %>% 
  dplyr::left_join(gdb_2020 %>% 
                     rename(P1105_LopNr_PersonNr = P1105_Lopnr_PersonNr) %>%
                     distinct(P1105_LopNr_PersonNr, DeSO)) 


main_data_stockholm <- main_data_stockholm %>% 
  dplyr::left_join(foreign_swed)# %>% 


main_data_stockholm <- main_data_stockholm %>% 
  dplyr::left_join(values_country, by = c('Country_name_SV' = 'country_in_data')) %>% 
  dplyr::left_join(risk_group, by = c('P1105_LopNr_PersonNr' = 'lopnr')) %>% 
  dplyr::left_join(length_stay, by = 'P1105_LopNr_PersonNr')


main_data_stockholm$length_stay_cat[main_data_stockholm$Country_name_SV == 'SVERIGE'] <- 'Born in Sweden'

main_data_stockholm$Risk_group[is.na(main_data_stockholm$Risk_group)] <- 'No'



```



Spillover code (click button on the right):
```{r education-outcome-Spillover, warning=FALSE}



ind_2020_Spillover <-  ind_2020




main_data_spillover <- ind_2020_Spillover %>% 
  dplyr::select(P1105_LopNr_PersonNr,DispInk04 ,DispInkFam04, Lan, Civil, Ssyk4_2012_J16 , Sun2020niva_old) %>% 
  mutate( Sun_name_catg = case_when(
    Sun2020niva_old == 0 | Sun2020niva_old == 1 |Sun2020niva_old == 2 ~ 'Primary School',
    Sun2020niva_old == 3 | Sun2020niva_old == 4 ~ 'Gymnasium',
    Sun2020niva_old == 5 | Sun2020niva_old == 6 |Sun2020niva_old == 7 ~ 'University',
    TRUE ~ NA
  ))



main_data_spillover <- main_data_spillover %>% 
  dplyr::left_join(fhm_nvr %>%  
                     distinct( P1105_LopNr_PersonNr, First_dose)) %>% 
  dplyr::left_join((pop %>%  
                      dplyr::select(P1105_LopNr_PersonNr, FodelseArMan, Kon) %>% 
                      distinct(P1105_LopNr_PersonNr, FodelseArMan, Kon))) %>% 
  dplyr::left_join(gdb_2020 %>% 
                     rename(P1105_LopNr_PersonNr = P1105_Lopnr_PersonNr) %>%
                     distinct(P1105_LopNr_PersonNr, DeSO)) 


main_data_spillover <- main_data_spillover %>% 
  dplyr::left_join(foreign_swed)# %>% 



main_data_spillover <- main_data_spillover %>% 
  dplyr::left_join(values_country, by = c('Country_name_SV' = 'country_in_data')) %>% 
  dplyr::left_join(risk_group, by = c('P1105_LopNr_PersonNr' = 'lopnr')) %>% 
  dplyr::left_join(length_stay, by = 'P1105_LopNr_PersonNr')


```



## Vaccination Opening Dates


## Individual Age Estimation

The age is at June 1st 2021 was calculated as *(2021-Age_year)+(6-Age_month)/12*


## Salary Estimations

Uppsala code (click button on the right):
```{r data-prep-for-table-1-uppsala, warning = FALSE}



main_data_uppsala <- main_data_uppsala %>% 
  mutate(Age_year = as.numeric(substr(FodelseArMan, 1,4)),
         Age_month = as.numeric(substr(FodelseArMan, 5,6)),
         age_formula = (2021-Age_year)+(6-Age_month)/12)


library(rio)


ind_before_birthcountry_missing <- length(unique(main_data_uppsala$P1105_LopNr_PersonNr))
main_data_uppsala <- main_data_uppsala %>% 
  
  filter(!is.na(FodelseArMan)) #%>% 
ind_AFTER_birthcountry_missing <- length(unique(main_data_uppsala$P1105_LopNr_PersonNr))



main_data_uppsala <- main_data_uppsala %>% 
  
  
  mutate(
    
    First_dose = as.Date(First_dose, format = '%Y-%m-%d'),
    vacc_date_opening_p_age = case_when(
      Age_year >= 1962 & Age_year <= 1971  ~ as.Date('24-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1972 & Age_year <= 1976  ~ as.Date('31-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1977 & Age_year <= 1981  ~ as.Date('07-06-2021', format = '%d-%m-%Y'),
      TRUE ~ NA
    ),
    
    days_btwn_opening_and_vacc = as.numeric(First_dose - vacc_date_opening_p_age),
    
    vaccinated_90days = case_when(
      days_btwn_opening_and_vacc <=90 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_30days = case_when(
      days_btwn_opening_and_vacc <=30 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_15days = case_when(
      days_btwn_opening_and_vacc <=15 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    
    
    vaccinated_0days = case_when(
      days_btwn_opening_and_vacc <0 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    Letter_received = case_when(
      Age_year >= 1962 & Age_year <=1971 ~ 'Letter',
      Age_year >= 1972 ~  'No letter',
      TRUE ~ NA
    )
  )


percentage_of_targeted_group_population <- main_data_uppsala %>% 
  filter( Letter_received == 'Letter')%>% 
  summarize(sum_50_59 = n())

percentage_of_nonTarget_group_population <- main_data_uppsala %>% 
  filter(  Age_year >= 1972 & Age_year <=1982 )%>% 
  summarize(sum_40_49 = n())


percentage_of_targeted_group_population_All_adult <- main_data_uppsala %>% 
  filter(Age_year <=2003) %>% 
  summarize(sum_all = n())


percentage_between_50_59 <- (percentage_of_targeted_group_population$sum_50_59/percentage_of_targeted_group_population_All_adult$sum_all)*100

percentage_between_40_49 <- (percentage_of_nonTarget_group_population$sum_50_59/percentage_of_targeted_group_population_All_adult$sum_all)*100








main_data_uppsala_tbl <- main_data_uppsala %>% 
  
  
  mutate(
    
    Letter_received = factor(Letter_received, levels = c('No letter', 'Letter')),
    
    Age_group = case_when(
      age_formula >= 39.5 & age_formula <49.5 ~ '39.5-49.4',
      age_formula >=49.5 & age_formula <= 59.4 ~ '49.5-59.4',
      TRUE ~ 'outside_range'),
    
    Age_group = factor(Age_group, levels = c('39.5-49.4', '49.5-59.4')),
    
    Birth_year_group = case_when(
      Age_year >= 1962 & Age_year <= 1971 ~ '1962 - 1971',
      Age_year >=1972 & Age_year <= 1981 ~ '1972 - 1981',
      TRUE ~ 'outside_range'),
    
    Birth_year_group = factor(Birth_year_group, levels = c('1962 - 1971', '1972 - 1981')),
    
    Sun_name_catg = factor(Sun_name_catg, levels = c('Primary School', 'Gymnasium' ,'University')),
    
    vaccinated_90days = factor(vaccinated_90days),
    vaccinated_30days = factor(vaccinated_30days),
    vaccinated_0days = factor(vaccinated_0days),
    
    sex = case_when(
      Kon == 1 ~ 'Male',
      Kon == 2 ~ 'Female',
      TRUE ~ NA
    ),
    sex = factor(sex),
    
    
    
    Foreign_vs_Sweden = case_when(
      Country_name_SV == 'SVERIGE' ~ 'Sweden' ,
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Abroad_LM',
      WB_Rank_2020 == 'H' ~ 'Abroad_High',
      
      TRUE ~ NA
    ), 
    Foreign_vs_Sweden = factor(Foreign_vs_Sweden, levels = c('Sweden', 'Abroad_LM', 'Abroad_High')),
    
    High_Low_Cntr = case_when(
      WB_Rank_2020 == 'H' ~ 'High',
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Middle_Low',
      TRUE ~ NA),
    High_Low_Cntr = factor(High_Low_Cntr, levels = c('Middle_Low', 'High'))) %>% 
  
  rename(Education = Sun_name_catg,
         Vax_within_90 = vaccinated_90days,
         Vax_within_30 = vaccinated_30days,
         Vax_within_0 = vaccinated_0days,
         
         age_formula = age_formula)








main_data_tbl_median_sal_uppsala <- main_data_uppsala_tbl %>% 
  group_by(Age_year,sex) %>% 
  summarize(md_sal_Ind_per_Birthyear = median(DispInk04)) %>% 
  ungroup()

main_data_uppsala_tbl_income <- main_data_uppsala_tbl %>% 
  filter(Age_group != 'NA') %>% 
  group_by( Age_group) %>% 
  mutate(Quantiles_income =ntile(DispInk04,4 ))


main_data_uppsala_tbl_income %>% 
  group_by(Letter_received, Quantiles_income) %>% 
  count()


main_data_uppsala_tbl <- main_data_uppsala_tbl %>% 
  left_join(main_data_tbl_median_sal_uppsala, by = c('Age_year','sex')) %>% 
  mutate(Ind_slr_cat = case_when(
    DispInk04 >= md_sal_Ind_per_Birthyear * 0.6666667 ~ 'High',
    DispInk04 < md_sal_Ind_per_Birthyear * 0.3333333 ~ 'Low',
    TRUE ~ 'Middle'
  ))


main_data_uppsala_tbl <- main_data_uppsala_tbl %>% 
  mutate( Educ_sex =   case_when(
    Education == 'Primary School' & sex == 'Female' ~ 'Primr_F',
    Education == 'Primary School' & sex == 'Male' ~ 'Primr_M',
    
    Education == 'Gymnasium' & sex == 'Female' ~ 'Gymns_F',
    Education == 'Gymnasium' & sex == 'Male' ~ 'Gymns_M',
    
    Education == 'University' & sex == 'Female' ~ 'Univ_F',
    Education == 'University' & sex == 'Male' ~ 'Univ_M',
    
    DispInk04 < md_sal_Ind_per_Birthyear ~ 'Low',
    TRUE ~ NA
  ))




main_data_uppsala_tbl_restricted_39_59 <- main_data_uppsala_tbl %>% 
  
  filter(Age_year <= (2021-40) & Age_year >= (2021-59)) 




main_data_uppsala_tbl_restricted_39_59 <- main_data_uppsala_tbl_restricted_39_59 %>% 
  mutate( First_dose = case_when(
    days_btwn_opening_and_vacc <= 90 ~ First_dose,
    TRUE ~ NA))


```




Gävle code (click button on the right):
```{r data-prep-for-table-1-gavle, warning = FALSE}




main_data_gavle <- main_data_gavle %>% 
  mutate(Age_year = as.numeric(substr(FodelseArMan, 1,4)),
         Age_month = as.numeric(substr(FodelseArMan, 5,6)),
         age_formula = (2021-Age_year)+(6-Age_month)/12)


main_data_gavle <- main_data_gavle %>% 
  
  filter(!is.na(FodelseArMan)) %>% 
  
  mutate(
    First_dose = as.Date(First_dose, format = '%Y-%m-%d'),
    vacc_date_opening_p_age = case_when(
      Age_year >= 1962 & Age_year <= 1966  ~ as.Date('03-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1967 & Age_year <= 1971  ~ as.Date('10-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1972 & Age_year <= 1975  ~ as.Date('24-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1976 & Age_year <= 1981  ~ as.Date('31-05-2021', format = '%d-%m-%Y'),
      TRUE ~ NA
    ),
    
    days_btwn_opening_and_vacc = as.numeric(First_dose - vacc_date_opening_p_age),
    
    vaccinated_90days = case_when(
      days_btwn_opening_and_vacc <=90 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_30days = case_when(
      days_btwn_opening_and_vacc <=30 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_15days = case_when(
      days_btwn_opening_and_vacc <=15 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    
    
    vaccinated_0days = case_when(
      days_btwn_opening_and_vacc <=0 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    Letter_received = case_when(
      Age_year >= 1962 & Age_year <=1971 ~ 'Letter',
      Age_year >= 1972 ~  'No letter',
      TRUE ~ NA
    )
  )







main_data_gavle_tbl <- main_data_gavle %>% 
  
  mutate(
    
    Letter_received = factor(Letter_received, levels = c('No letter', 'Letter')),
    
    Age_group = case_when(
      age_formula >= 39.5 & age_formula <49.5 ~ '39.5-49.4',
      age_formula >=49.5 & age_formula <= 59.4 ~ '49.5-59.4',
      TRUE ~ 'outside_range'),
    
    Age_group = factor(Age_group, levels = c('39.5-49.4', '49.5-59.4')),
    
    Birth_year_group = case_when(
      Age_year >= 1962 & Age_year <= 1971 ~ '1962 - 1971',
      Age_year >=1972 & Age_year <= 1981 ~ '1972 - 1981',
      TRUE ~ 'outside_range'),
    
    Birth_year_group = factor(Birth_year_group, levels = c('1962 - 1971', '1972 - 1981')),
    
    Sun_name_catg = factor(Sun_name_catg, levels = c('Primary School', 'Gymnasium' ,'University')),
    
    vaccinated_90days = factor(vaccinated_90days),
    vaccinated_30days = factor(vaccinated_30days),
    vaccinated_0days = factor(vaccinated_0days),
    
    sex = case_when(
      Kon == 1 ~ 'Male',
      Kon == 2 ~ 'Female',
      TRUE ~ NA
    ),
    sex = factor(sex),
    
    
    
    Foreign_vs_Sweden = case_when(
      Country_name_SV == 'SVERIGE' ~ 'Sweden' ,
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Abroad_LM',
      WB_Rank_2020 == 'H' ~ 'Abroad_High',
      
      TRUE ~ NA
    ), 
    Foreign_vs_Sweden = factor(Foreign_vs_Sweden, levels = c('Sweden', 'Abroad_LM', 'Abroad_High')),
    
    High_Low_Cntr = case_when(
      WB_Rank_2020 == 'H' ~ 'High',
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Middle_Low',
      TRUE ~ NA),
    High_Low_Cntr = factor(High_Low_Cntr, levels = c('Middle_Low', 'High'))) %>% 
  
  rename(Education = Sun_name_catg,
         Vax_within_90 = vaccinated_90days,
         Vax_within_30 = vaccinated_30days,
         Vax_within_0 = vaccinated_0days,
         
         age_formula = age_formula)









main_data_tbl_median_sal_gavle <- main_data_gavle_tbl %>% 
  group_by(Age_year,sex) %>% 
  summarize(md_sal_Ind_per_Birthyear = median(DispInk04)) %>% 
  ungroup()


main_data_gavle_tbl <- main_data_gavle_tbl %>% 
  left_join(main_data_tbl_median_sal_gavle, by = c('Age_year','sex')) %>% 
  mutate(Ind_slr_cat = case_when(
    DispInk04 >= md_sal_Ind_per_Birthyear * 0.6666667 ~ 'High',
    DispInk04 < md_sal_Ind_per_Birthyear * 0.3333333 ~ 'Low',
    TRUE ~ 'Middle'
  ))


main_data_gavle_tbl <- main_data_gavle_tbl %>% 
  mutate( Educ_sex =   case_when(
    Education == 'Primary School' & sex == 'Female' ~ 'Primr_F',
    Education == 'Primary School' & sex == 'Male' ~ 'Primr_M',
    
    Education == 'Gymnasium' & sex == 'Female' ~ 'Gymns_F',
    Education == 'Gymnasium' & sex == 'Male' ~ 'Gymns_M',
    
    Education == 'University' & sex == 'Female' ~ 'Univ_F',
    Education == 'University' & sex == 'Male' ~ 'Univ_M',
    
    DispInk04 < md_sal_Ind_per_Birthyear ~ 'Low',
    TRUE ~ NA
  ))





main_data_gavle_tbl_restricted_39_59 <- main_data_gavle_tbl %>% 
  filter(Age_year <= (2021-40) & Age_year >= (2021-59)) 



```






Stockholm code (click button on the right):
```{r data-prep-for-table-1-stockholm, warning = FALSE}




main_data_stockholm <- main_data_stockholm %>% 
  mutate(Age_year = as.numeric(substr(FodelseArMan, 1,4)),
         Age_month = as.numeric(substr(FodelseArMan, 5,6)),
         age_formula = (2021-Age_year)+(6-Age_month)/12)


library(rio)

main_data_stockholm <- main_data_stockholm %>% 
  
  filter(!is.na(FodelseArMan)) #%>% 




main_data_stockholm <- main_data_stockholm %>% 
  
  
  mutate(
    First_dose = as.Date(First_dose, format = '%Y-%m-%d'),
    vacc_date_opening_p_age = case_when(
      Age_year >= 1962 & Age_year <= 1966  ~ as.Date('03-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1967 & Age_year <= 1971  ~ as.Date('10-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1972 & Age_year <= 1975  ~ as.Date('17-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1976 & Age_year <= 1981  ~ as.Date('31-05-2021', format = '%d-%m-%Y'),
      TRUE ~ NA
    ),
    
    days_btwn_opening_and_vacc = as.numeric(First_dose - vacc_date_opening_p_age),
    
    vaccinated_90days = case_when(
      days_btwn_opening_and_vacc <=90 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_30days = case_when(
      days_btwn_opening_and_vacc <=30 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    vaccinated_15days = case_when(
      days_btwn_opening_and_vacc <=15 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    
    
    vaccinated_0days = case_when(
      days_btwn_opening_and_vacc <0 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    Letter_received = case_when(
      Age_year >= 1962 & Age_year <=1971 ~ 'Letter',
      Age_year >= 1972 ~  'No letter',
      TRUE ~ NA
    )
  )








main_data_stockholm_tbl <- main_data_stockholm %>% 
  
  
  mutate(
    
    Letter_received = factor(Letter_received, levels = c('No letter', 'Letter')),
    
    Age_group = case_when(
      age_formula >= 39.5 & age_formula <49.5 ~ '39.5-49.4',
      age_formula >=49.5 & age_formula <= 59.4 ~ '49.5-59.4',
      TRUE ~ 'outside_range'),
    
    Age_group = factor(Age_group, levels = c('39.5-49.4', '49.5-59.4')),
    
    Birth_year_group = case_when(
      Age_year >= 1962 & Age_year <= 1971 ~ '1962 - 1971',
      Age_year >=1972 & Age_year <= 1981 ~ '1972 - 1981',
      TRUE ~ 'outside_range'),
    
    Birth_year_group = factor(Birth_year_group, levels = c('1962 - 1971', '1972 - 1981')),
    
    Sun_name_catg = factor(Sun_name_catg, levels = c('Primary School', 'Gymnasium' ,'University')),
    
    vaccinated_90days = factor(vaccinated_90days),
    vaccinated_30days = factor(vaccinated_30days),
    vaccinated_0days = factor(vaccinated_0days),
    
    sex = case_when(
      Kon == 1 ~ 'Male',
      Kon == 2 ~ 'Female',
      TRUE ~ NA
    ),
    sex = factor(sex),
    
    
    
    Foreign_vs_Sweden = case_when(
      Country_name_SV == 'SVERIGE' ~ 'Sweden' ,
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Abroad_LM',
      WB_Rank_2020 == 'H' ~ 'Abroad_High',
      
      TRUE ~ NA
    ), 
    Foreign_vs_Sweden = factor(Foreign_vs_Sweden, levels = c('Sweden', 'Abroad_LM', 'Abroad_High')),
    
    High_Low_Cntr = case_when(
      WB_Rank_2020 == 'H' ~ 'High',
      WB_Rank_2020 == 'UM' | WB_Rank_2020 == "LM" | WB_Rank_2020 == 'L' ~ 'Middle_Low',
      TRUE ~ NA),
    High_Low_Cntr = factor(High_Low_Cntr, levels = c('Middle_Low', 'High'))) %>% 
  
  rename(Education = Sun_name_catg,
         Vax_within_90 = vaccinated_90days,
         Vax_within_30 = vaccinated_30days,
         Vax_within_0 = vaccinated_0days,
         
         age_formula = age_formula)







main_data_tbl_median_sal_stockholm <- main_data_stockholm_tbl %>% 
  group_by(Age_year,sex) %>% 
  summarize(md_sal_Ind_per_Birthyear = median(DispInk04)) %>% 
  ungroup()

main_data_stockholm_tbl <- main_data_stockholm_tbl %>% 
  left_join(main_data_tbl_median_sal_stockholm, by = c('Age_year','sex')) %>% 
  mutate(Ind_slr_cat = case_when(
    DispInk04 >= md_sal_Ind_per_Birthyear * 0.6666667 ~ 'High',
    DispInk04 < md_sal_Ind_per_Birthyear * 0.3333333 ~ 'Low',
    TRUE ~ 'Middle'
  ))


main_data_stockholm_tbl <- main_data_stockholm_tbl %>% 
  mutate( Educ_sex =   case_when(
    Education == 'Primary School' & sex == 'Female' ~ 'Primr_F',
    Education == 'Primary School' & sex == 'Male' ~ 'Primr_M',
    
    Education == 'Gymnasium' & sex == 'Female' ~ 'Gymns_F',
    Education == 'Gymnasium' & sex == 'Male' ~ 'Gymns_M',
    
    Education == 'University' & sex == 'Female' ~ 'Univ_F',
    Education == 'University' & sex == 'Male' ~ 'Univ_M',
    
    DispInk04 < md_sal_Ind_per_Birthyear ~ 'Low',
    TRUE ~ NA
  ))




main_data_stockholm_tbl_restricted_39_59 <- main_data_stockholm_tbl %>% 
  
  filter(Age_year <= (2021-40) & Age_year >= (2021-59)) 



```




Spillover code (click button on the right):
```{r data-prep-for-table-1-spillover, warning = FALSE}




main_data_spillover <- main_data_spillover %>% 
  mutate(Age_year = as.numeric(substr(FodelseArMan, 1,4)),
         Age_month = as.numeric(substr(FodelseArMan, 5,6)),
         age_formula = (2021-Age_year)+(6-Age_month)/12)


main_data_spillover <- main_data_spillover %>% 
  
  
  mutate(
    
    First_dose = as.Date(First_dose, format = '%Y-%m-%d'),
    vacc_date_opening_p_age = case_when(
      Age_year >= 1962 & Age_year <= 1971  ~ as.Date('24-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1972 & Age_year <= 1976  ~ as.Date('31-05-2021', format = '%d-%m-%Y'),
      Age_year >= 1977 & Age_year <= 1981  ~ as.Date('07-06-2021', format = '%d-%m-%Y'),
      TRUE ~ NA
    ),
    
    days_btwn_opening_and_vacc = as.numeric(First_dose - vacc_date_opening_p_age),
    
    vaccinated_90days = case_when(
      days_btwn_opening_and_vacc <=90 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    
    vaccinated_0days = case_when(
      days_btwn_opening_and_vacc <0 ~ 'Yes',
      TRUE ~ 'No'
    ),
    
    Letter_received = case_when(
      Age_year >= 1962 & Age_year <=1971 ~ 'Letter',
      Age_year >= 1972 ~  'No letter',
      TRUE ~ NA
    )
  )








main_data_spillover_tbl <- main_data_spillover %>% 
  
  
  mutate(
    
    Letter_received = factor(Letter_received, levels = c('No letter', 'Letter')),
    
    Age_group = case_when(
      age_formula >= 39.5 & age_formula <49.5 ~ '39.5-49.4',
      age_formula >=49.5 & age_formula <= 59.4 ~ '49.5-59.4',
      TRUE ~ 'outside_range'),
    
    Age_group = factor(Age_group, levels = c('39.5-49.4', '49.5-59.4')),
    
    Birth_year_group = case_when(
      Age_year >= 1962 & Age_year <= 1971 ~ '1962 - 1971',
      Age_year >=1972 & Age_year <= 1981 ~ '1972 - 1981',
      TRUE ~ 'outside_range'),
    
    Birth_year_group = factor(Birth_year_group, levels = c('1962 - 1971', '1972 - 1981')),
    
    
    vaccinated_90days = factor(vaccinated_90days),
    
    sex = case_when(
      Kon == 1 ~ 'Male',
      Kon == 2 ~ 'Female',
      TRUE ~ NA
    ),
    sex = factor(sex)
    
    
    
  ) %>% 
  
  rename(
    Vax_within_90 = vaccinated_90days,
    
    age_formula = age_formula)



```





Spillover
```{r data-spillover, warning = FALSE}



main_data_Spillover_tbl_restricted_39_49 <- main_data_uppsala_tbl_restricted_39_59 %>% 
  filter(Age_year <= (2021-40) & Age_year >= (2021-49)) %>% 
  dplyr::select(P1105_LopNr_PersonNr      ,
                DispInk04                 ,
                Education                 ,
                Educ_sex,
                First_dose                ,
                Age_year                  ,  
                Age_month,
                age_formula                   ,
                vacc_date_opening_p_age   ,
                Vax_within_90             ,
                Letter_received           ,
                sex               ,
                FodelseArMan,
                Foreign_vs_Sweden         ,
                High_Low_Cntr      ,
                Ind_slr_cat,
                Birth_year_group,
                
                Risk_group, length_stay_cat, trust_catgr,
                
                Vax_within_0
                
  )

colnames(main_data_Spillover_tbl_restricted_39_49) <- paste0(colnames(main_data_Spillover_tbl_restricted_39_49), '_influenced')


ind_RTB <-  fread("data.csv") 

main_data_Spillover_tbl_restricted_39_49 <- main_data_Spillover_tbl_restricted_39_49 %>% 
  left_join(ind_RTB, by = c('P1105_LopNr_PersonNr_influenced'='P1105_LopNr_PersonNr'))

main_data_Spillover_tbl_restricted_39_49 <- main_data_Spillover_tbl_restricted_39_49 %>%
  mutate(partner_ID =coalesce(P1105_LopNr_PersonNrSambo, P1105_LopNr_PersonNrMakPart))


main_data_Spillover_tbl_restricted_39_49 <- main_data_Spillover_tbl_restricted_39_49 %>%
  filter(!is.na(partner_ID))

length(unique(main_data_Spillover_tbl_restricted_39_49$P1105_LopNr_PersonNr_influenced))






main_data_spillover_tbl_influencer <- main_data_spillover_tbl %>% 
  dplyr::select(P1105_LopNr_PersonNr, Age_year, FodelseArMan, Age_month, age_formula, Birth_year_group,Letter_received, Lan)

colnames(main_data_spillover_tbl_influencer) <- paste0(colnames(main_data_spillover_tbl_influencer), '_influencer')

main_data_Spillover_Partnered_Influencer <- main_data_Spillover_tbl_restricted_39_49 %>% 
  left_join(main_data_spillover_tbl_influencer, by =c('partner_ID' = 'P1105_LopNr_PersonNr_influencer' ))

main_data_Spillover_Partnered_Influencer <- main_data_Spillover_Partnered_Influencer %>% 
  mutate(pair_age_differ = age_formula_influenced - age_formula_influencer)

length(unique(main_data_Spillover_Partnered_Influencer$P1105_LopNr_PersonNr_influenced))

main_data_Spillover_Partnered_Influencer <- main_data_Spillover_Partnered_Influencer %>% 
  filter(Lan_influencer == 3)
length(unique(main_data_Spillover_Partnered_Influencer$P1105_LopNr_PersonNr_influenced))



missing_partner_age <- main_data_Spillover_Partnered_Influencer %>% 
  filter(is.na(age_formula_influencer))

ids_missing_partners <- as.numeric(missing_partner_age$partner_ID)
ind_2020$P1105_LopNr_PersonNr <- as.numeric(ind_2020$P1105_LopNr_PersonNr)

non_matching_partners_ind <-  ind_2020 %>% 
  filter(P1105_LopNr_PersonNr %in% missing_partner_age$partner_ID )

length(ids_missing_partners)

Spillover_data <- main_data_Spillover_Partnered_Influencer %>% 
  filter(!is.na(age_formula_influencer)) 
length(unique(Spillover_data$P1105_LopNr_PersonNr_influenced))


Spillover_data <- Spillover_data %>% 
  filter(Age_year_influencer <= 1981 & Age_year_influencer >= 1962) 
length(unique(Spillover_data$P1105_LopNr_PersonNr_influenced))



```



# Table 1

## Table Processing

Table data code (click button on the right):
```{r table-1-setup, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(table1)

main_data_Table1_uppsala <- main_data_uppsala_tbl_restricted_39_59 %>%
  dplyr::select(First_dose,
                Birth_year_group,
                Vax_within_90, 
                Vax_within_0,
                sex, age_formula, Foreign_vs_Sweden,
                DispInk04,
                Ind_slr_cat, 
                Risk_group, length_stay_cat, trust_catgr,
                Education, Letter_received)


main_data_Table1_uppsala <- main_data_Table1_uppsala %>% 
  mutate(
    Salary_Birth = case_when(
      Birth_year_group ==  '1962 - 1971' & Ind_slr_cat == 'Low' ~ '50_59_Low',
      Birth_year_group ==  '1962 - 1971' & Ind_slr_cat == 'Middle' ~ '50_59_Middle',
      Birth_year_group ==  '1962 - 1971' & Ind_slr_cat == 'High' ~ '50_59_High',
      
      Birth_year_group ==  '1972 - 1981' & Ind_slr_cat == 'Low' ~ '40_49_Low',
      Birth_year_group ==  '1972 - 1981' & Ind_slr_cat == 'Middle' ~ '50_59_Middle',
      Birth_year_group ==  '1972 - 1981' & Ind_slr_cat == 'High' ~ '40_49_High',
      TRUE ~ NA
    )
  )

main_data_Table1_uppsala_vacc_dates <- main_data_Table1_uppsala %>% 
  group_by(Letter_received) %>% 
  summarize(
    min_date = min(First_dose, na.rm=T),
    max_date = max(First_dose, na.rm=T)) %>% 
  ungroup() #%>% 


main_data_Table1_uppsala_Salary_Birth <- main_data_Table1_uppsala %>%
  group_by(Salary_Birth, Letter_received) %>%
  summarize(md_Ind_slr_cat = median(DispInk04)) %>%
  ungroup()

main_data_Table1_uppsala_Salary_Birth_IQR <- main_data_Table1_uppsala %>%
  group_by(Salary_Birth, Letter_received) %>%
  summarize(
    median_income = round(median(DispInk04)),
    lower_Q_income = round(quantile(DispInk04, 0.333333)),
    upper_income = round(quantile(DispInk04,0.6666667)),
    interquartile_income = round(IQR(DispInk04))) %>%
  ungroup()



main_data_Table1_uppsala_Salary_Birth_Total <- main_data_Table1_uppsala %>%
  group_by(Ind_slr_cat) %>% 
  summarize(md_Ind_slr_cat = median(DispInk04)) %>%
  ungroup()






Income_summary_Table_uppsala <-  main_data_Table1_uppsala %>%
  group_by(Ind_slr_cat, Letter_received) %>% 
  summarize(
    median_income = round(median(DispInk04)),
    lower_income = round(quantile(DispInk04, 0.333333)),
    upper_income = round(quantile(DispInk04, 0.666667))
    
  ) %>% 
  mutate(income_display = sprintf('%.0f (%.0f-%.0f)',
                                  median_income,
                                  lower_income,
                                  upper_income)) %>% 
  dplyr::select(Ind_slr_cat, Letter_received, income_display) %>% 
  pivot_wider(
    names_from = Letter_received,
    values_from = income_display
  )







label(main_data_Table1_uppsala$Birth_year_group) <- 'Birth year'
label(main_data_Table1_uppsala$Education) <- 'Education'
label(main_data_Table1_uppsala$sex) <- 'sex'
label(main_data_Table1_uppsala$Foreign_vs_Sweden) <- 'Birth country**'




label(main_data_Table1_uppsala$age_formula) <- 'Age *'
label(main_data_Table1_uppsala$Vax_within_90) <- 'Vaccinated within 90d***'
label(main_data_Table1_uppsala$Vax_within_0) <- 'Vaccinated ahead of time'

label(main_data_Table1_uppsala$Risk_group) <- 'Risk group status'
label(main_data_Table1_uppsala$length_stay_cat) <- 'Length of stay'
label(main_data_Table1_uppsala$trust_catgr) <- 'Birth country trust level'

main_data_Table1_uppsala_main <- main_data_Table1_uppsala %>% 
  dplyr::select(sex,
                age_formula,
                Birth_year_group ,
                Foreign_vs_Sweden,
                Education ,
                Risk_group, length_stay_cat, trust_catgr,
                Vax_within_0,
                Vax_within_90, Letter_received )




main_data_Table1_gavle <- main_data_gavle_tbl_restricted_39_59 %>%
  dplyr::select(First_dose,
                Birth_year_group,
                Vax_within_90,
                Vax_within_0, 
                sex, age_formula, Foreign_vs_Sweden,
                Risk_group, length_stay_cat, trust_catgr,
                
                DispInk04,
                Ind_slr_cat, Education, Letter_received)

main_data_Table1_gavle <- main_data_Table1_gavle %>% 
  mutate(
    Salary_Birth = case_when(
      Birth_year_group ==  '1962 - 1971' & Ind_slr_cat == 'Low' ~ '50_59_Low',
      Birth_year_group ==  '1962 - 1971' & Ind_slr_cat == 'Middle' ~ '50_59_Middle',
      Birth_year_group ==  '1962 - 1971' ~ '50_59_High',
      
      Birth_year_group ==  '1972 - 1981' & Ind_slr_cat == 'Low' ~ '40_49_Low',
      Birth_year_group ==  '1972 - 1981' & Ind_slr_cat == 'Middle' ~ '50_59_Middle',
      Birth_year_group ==  '1972 - 1981' ~ '40_49_High',
      TRUE ~ NA
    )
  )







main_data_Table1_gavle_vacc_dates <- main_data_Table1_gavle %>% 
  group_by(Letter_received) %>% 
  summarize(
    min_date = min(First_dose, na.rm=T),
    max_date = max(First_dose, na.rm=T)) %>% 
  ungroup() #%>% 

main_data_Table1_gavle_Salary_Birth <- main_data_Table1_gavle %>%
  group_by(Salary_Birth) %>%
  summarize(md_Ind_slr_cat = median(DispInk04)) %>%
  ungroup()

main_data_Table1_gavle_Salary_Birth_IQR <- main_data_Table1_gavle %>%
  
  group_by(Salary_Birth, Letter_received) %>%
  summarize(
    median_income = round(median(DispInk04)),
    lower_Q_income = round(quantile(DispInk04, 0.333333)),
    upper_income = round(quantile(DispInk04,0.6666667)),
    interquartile_income = round(IQR(DispInk04))) %>%
  ungroup()








label(main_data_Table1_gavle$Birth_year_group) <- 'Birth year'
label(main_data_Table1_gavle$Education) <- 'Education'
label(main_data_Table1_gavle$sex) <- 'sex'
label(main_data_Table1_gavle$Foreign_vs_Sweden) <- 'Birth country**'

label(main_data_Table1_gavle$age_formula) <- 'Age *'
label(main_data_Table1_gavle$Vax_within_90) <- 'Vaccinated within 90d***'
label(main_data_Table1_gavle$Vax_within_0) <- 'Vaccinated ahead of time'

label(main_data_Table1_gavle$Risk_group) <- 'Risk group status'
label(main_data_Table1_gavle$length_stay_cat) <- 'Length of stay'
label(main_data_Table1_gavle$trust_catgr) <- 'Birth country trust level'

main_data_Table1_gavle_main <- main_data_Table1_gavle %>% 
  dplyr::select(sex,
                age_formula,
                Birth_year_group ,
                Foreign_vs_Sweden,
                Education ,
                Vax_within_0,
                Risk_group, length_stay_cat, trust_catgr,
                
                Vax_within_90,
                Letter_received )




main_data_Table1_Spillover <- Spillover_data %>%
  dplyr::select(First_dose_influenced,
                Birth_year_group_influenced,
                Vax_within_90_influenced,
                Vax_within_0_influenced, 
                sex_influenced, age_formula_influenced, Foreign_vs_Sweden_influenced,
                DispInk04_influenced,
                Risk_group_influenced, length_stay_cat_influenced, trust_catgr_influenced,
                
                Ind_slr_cat_influenced, Education_influenced,
                Birth_year_group_influencer,
                Letter_received_influencer)





pvalue <- function(x,name, ...) {
  x <- x[names(x) != 'overall']
  y <- unlist(x)
  g <- factor(rep(1:length(x), times=sapply(x, length)))
  if (is.numeric(y)) {
    p <- t.test(y ~ g)$p.value
  } else {
    p <- chisq.test(table(y, g))$p.value
  }
  c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}


Income_summary_Table_uppsala

```



## Table 1 - Uppsala

```{r table1-uppsala, warning = FALSE}

table1(~ sex + 
         age_formula + 
         trust_catgr+
         
         length_stay_cat+
         Education + 
         Risk_group +
         
         Vax_within_0+
         Vax_within_90  | Letter_received, 
       overall =  c(right = 'Total'), # F,
       caption = 'Uppsala',
       extra.col=list(`P-value`=pvalue),
       footnote = c('* Age calculated as (2021-Age_year)+(6-Age_month)/12',
                    '** Based on the World Bank data (Middle_Low includes Upper-Middle, Middle and Low Income countries',
                    '*** Within XX days from the opening date corresponding to the birth year'),
       data = main_data_Table1_uppsala_main)




avg_mean_age <- tapply(main_data_Table1_uppsala_main$age_formula, main_data_Table1_uppsala_main$Letter_received,mean)

ci_per_group <- tapply(main_data_Table1_uppsala_main$age_formula, main_data_Table1_uppsala_main$Letter_received, function(x) (t.test(x)$conf.int))



```



Confidence intervals for mean age
```{r table1-uppsala-age_conf_inter, warning = FALSE}



avg_per_group <- tapply(main_data_Table1_uppsala_main$age_formula,  main_data_Table1_uppsala_main$Letter_received, mean)
sd_per_group <- tapply(main_data_Table1_uppsala_main$age_formula,  main_data_Table1_uppsala_main$Letter_received, sd)
n_per_group <- tapply(main_data_Table1_uppsala_main$age_formula,  main_data_Table1_uppsala_main$Letter_received, length)

confidence_level <- 0.95
df <- n_per_group - 1
t_value <- qt((1 + confidence_level) / 2, df)

margin_of_error <- sd_per_group / sqrt(n_per_group) * t_value
ci_lower <- round(avg_per_group - margin_of_error, 1)
ci_upper <- round(avg_per_group + margin_of_error,1)

ci_per_group <- cbind(ci_lower, ci_upper)
print(ci_per_group)

```



```{r table1-uppsala-vax-dates, warning = FALSE}

library(knitr)
library(kableExtra)



main_data_Table1_uppsala_vacc_dates %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '350px' ,height = '250px') 

```




```{r table1-uppsala-income, warning = FALSE}





main_data_Table1_uppsala_Salary_Birth %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '250px' ,height = '250px') 


contingency_talbe  <- table(main_data_Table1_uppsala_Salary_Birth$Letter_received, main_data_Table1_uppsala_Salary_Birth$md_Ind_slr_cat)

chi_squared_income <- chisq.test(contingency_talbe)
p_value_income <- chi_squared_income$p.value






```


The pvalue for income is `r p_value_income`



```{r table1-uppsala-income-IQR, warning = FALSE}





main_data_Table1_uppsala_Salary_Birth_IQR %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '950px' ,height = '400px') 


```




```{r table1-uppsala-income-total, warning = FALSE}





main_data_Table1_uppsala_Salary_Birth_Total %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '250px' ,height = '250px') 




```



## Table 1 - Spillover Uppsala




```{r table1-spillover, warning = FALSE}



table1(~ sex_influenced + 
         age_formula_influenced + 
         Birth_year_group_influencer   + 
         Foreign_vs_Sweden_influenced + 
         Education_influenced + 
         Risk_group_influenced+
         length_stay_cat_influenced+
         trust_catgr_influenced+
         
         Vax_within_0_influenced +
         Vax_within_90_influenced  | Letter_received_influencer, 
       overall =  c(right = 'Total'), # F,
       caption = 'Uppsala',
       extra.col=list(`P-value`=pvalue),
       footnote = c('* Age calculated as (2021-Age_year)+(6-Age_month)/12',
                    '** Based on the World Bank data (Middle_Low includes Upper-Middle, Middle and Low Income countries',
                    '*** Within XX days from the opening date corresponding to the birth year'),
       data = main_data_Table1_Spillover_main)


```




```{r table1-spillover-vax-dates, warning = FALSE}

library(knitr)
library(kableExtra)



main_data_Table1_Spillover_vacc_dates %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '350px' ,height = '250px') 

```

```{r table1-spillover-income, warning = FALSE}





main_data_Table1_Spillover_Salary_Birth %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '450px' ,height = '250px') 

```




## Table 1 - Gävle

```{r table1-gavle, warning = FALSE}

table1(~  sex + 
         age_formula + 
         Birth_year_group   + 
         Foreign_vs_Sweden + 
         Education + 
         Vax_within_0+
         Vax_within_90  | Letter_received, 
       overall =  c(right = 'Total'), # F,
       caption = 'Gävle',
       extra.col=list(`P-value`=pvalue),
       footnote = c('* Age calculated as (2021-Age_year)+(6-Age_month)/12',
                    '** Based on the World Bank data (Middle_Low includes Upper-Middle, Middle and Low Income countries',
                    '*** Within XX days from the opening date corresponding to the birth year'),
       data = main_data_Table1_gavle)
```


```{r table1-gavle-vax-dates, warning = FALSE}

library(knitr)
library(kableExtra)



main_data_Table1_gavle_vacc_dates %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '350px' ,height = '250px') 

```

```{r table1-gavle-income, warning = FALSE}





main_data_Table1_gavle_Salary_Birth %>% 
  
  kable %>% 
  kable_styling('striped', full_width = F) %>% 
  scroll_box(width = '250px' ,height = '250px') 

```

# Vaccination Plots

## Data Preparation for Plots

Code for Uppsala (click button on the right):
```{r vaccination-data-process-uppsala, warning = FALSE}






pop_per_agegroup <- pop %>% 
  dplyr::select(P1105_LopNr_PersonNr, FodelseArMan, Kon ) %>% 
  mutate(Age_year = as.numeric(substr(FodelseArMan, 1,4)),
         Age_month = as.numeric(substr(FodelseArMan, 5,6)),
         age_formula = (2021-Age_year)+(6-Age_month)/12) %>% 
  mutate(Age_group = case_when(
    age_formula >= 0 & age_formula <16  ~ '15-',
    age_formula >= 16 & age_formula <18 ~ '16-17',
    age_formula >= 18 & age_formula <20 ~ '18-19',
    
    age_formula >= 20 & age_formula <30 ~ '20-29',
    age_formula >= 30 & age_formula <40 ~ '30-39',
    age_formula >= 40 & age_formula <50 ~ '40-49',
    age_formula >=50 & age_formula < 60 ~ '50-59',
    age_formula >=60 & age_formula < 70 ~ '60-69',
    age_formula >=70 & age_formula < 80 ~ '70-79',
    age_formula >=80 & age_formula < 90 ~ '80-89',
    age_formula >=90 ~ '90+',
    
    TRUE ~ NA),
    
    Birth_year_group = case_when(
      Age_year >= 1962 & Age_year <= 1971 ~ '1962 - 1971',
      Age_year >=1972 & Age_year <= 1981 ~ '1972 - 1981',
      TRUE ~ 'outside_range'),
    
    Birth_year_group = factor(Birth_year_group, levels = c('1962 - 1971', '1972 - 1981')),
    
  )


population_Birth_Year_Grp_uppsala <- main_data_uppsala_tbl %>% 
  left_join(pop_per_agegroup) %>% 
  group_by(Birth_year_group) %>% 
  summarise(population = n()) %>% 
  ungroup()


pulation_Entire_uppsala_18_plus <- main_data_uppsala_tbl %>% 
  left_join(pop_per_agegroup) %>% 
  summarise(population = n()) %>% 
  ungroup()


main_data_uppsala_tbl <- main_data_uppsala_tbl %>% 
  mutate(Age_group = case_when(
    age_formula >= 0 & age_formula <16  ~ '15-',
    
    age_formula >= 16 & age_formula <18 ~ '16-17',
    age_formula >= 18 & age_formula <20 ~ '18-19',
    
    age_formula >= 20 & age_formula <30 ~ '20-29',
    age_formula >= 30 & age_formula <40 ~ '30-39',
    age_formula >= 40 & age_formula <50 ~ '40-49',
    age_formula >=50 & age_formula < 60 ~ '50-59',
    age_formula >=60 & age_formula < 70 ~ '60-69',
    age_formula >=70 & age_formula < 80 ~ '70-79',
    age_formula >=80 & age_formula < 90 ~ '80-89',
    age_formula >=90 ~ '90+',
    
    TRUE ~ NA))




library(lubridate)

cum_vacc_upps_39_59 <- main_data_uppsala_tbl_restricted_39_59 %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_upps_39_59 <- cum_vacc_upps_39_59 %>% 
  group_by(Birth_year_group) %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )

library(ISOweek)
date_in_week <- function(year, week, weekday){
  w <- paste0(year, "-W", sprintf("%02d", week), "-", weekday)
  ISOweek2date(w)
}


cum_vacc_upps_39_59 <- cum_vacc_upps_39_59 %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  left_join(population_Birth_Year_Grp_uppsala, by ='Birth_year_group') %>% 
  mutate(cum_share = round(cum_vax/population, digits= 3))



cum_vacc_upps_39_59_both_cohorts <- main_data_uppsala_tbl_restricted_39_59 %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_upps_39_59_both_cohorts <- cum_vacc_upps_39_59_both_cohorts %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )


cum_vacc_upps_39_59_both_cohorts <- cum_vacc_upps_39_59_both_cohorts %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  mutate(population = sum(population_Birth_Year_Grp_uppsala[1,2], population_Birth_Year_Grp_uppsala[2,2])) %>%
  mutate(cum_share = round(cum_vax/population, digits= 3))




cum_vacc_upps_entire <- main_data_uppsala_tbl %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_upps_entire <- cum_vacc_upps_entire %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )

cum_vacc_upps_18_plus <- cum_vacc_upps_entire %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  mutate(population = pulation_Entire_uppsala_18_plus$population) %>% 
  mutate(cum_share = round(cum_vax/population, digits= 3))






```


Code for Gävle (click button on the right):
```{r vaccination-data-process-gavle, warning = FALSE}







population_ageGrp_gavle <- ind_2020_gavle %>% 
  left_join(pop_per_agegroup) %>% 
  group_by(Age_group) %>% 
  summarise(population = n()) %>% 
  ungroup()


population_Birth_Year_Grp_gavle <- main_data_gavle_tbl %>% 
  left_join(pop_per_agegroup) %>% 
  group_by(Birth_year_group) %>% 
  summarise(population = n()) %>% 
  ungroup()


pulation_Entire_gavle_18_plus <- main_data_gavle_tbl %>% 
  left_join(pop_per_agegroup) %>% 
  summarise(population = n()) %>% 
  ungroup()

main_data_gavle_tbl_restricted_39_59 <- main_data_gavle_tbl_restricted_39_59 %>% 
  mutate(Age_group = case_when(
    age_formula >= 0 & age_formula <16  ~ '15-',
    
    age_formula >= 16 & age_formula <18 ~ '16-17',
    age_formula >= 18 & age_formula <20 ~ '18-19',
    
    age_formula >= 20 & age_formula <30 ~ '20-29',
    age_formula >= 30 & age_formula <40 ~ '30-39',
    age_formula >= 40 & age_formula <50 ~ '40-49',
    age_formula >=50 & age_formula < 60 ~ '50-59',
    age_formula >=60 & age_formula < 70 ~ '60-69',
    age_formula >=70 & age_formula < 80 ~ '70-79',
    age_formula >=80 & age_formula < 90 ~ '80-89',
    age_formula >=90 ~ '90+',
    
    TRUE ~ NA))

cum_vacc_gavl_39_59 <- main_data_gavle_tbl_restricted_39_59 %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_gavl_39_59 <- cum_vacc_gavl_39_59 %>% 
  group_by(Birth_year_group) %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )



cum_vacc_gavl_39_59 <- cum_vacc_gavl_39_59 %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  left_join(population_Birth_Year_Grp_gavle, by ='Birth_year_group') %>% 
  mutate(cum_share = round(cum_vax/population, digits= 3))




cum_vacc_gavl_39_59_both_cohorts <- main_data_gavle_tbl_restricted_39_59 %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_gavl_39_59_both_cohorts <- cum_vacc_gavl_39_59_both_cohorts %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )


cum_vacc_gavl_39_59_both_cohorts <- cum_vacc_gavl_39_59_both_cohorts %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  mutate(population = sum(population_Birth_Year_Grp_uppsala[1,2], population_Birth_Year_Grp_uppsala[2,2])) %>%
  mutate(cum_share = round(cum_vax/population, digits= 3))




cum_vacc_gavl_entire <- main_data_uppsala_tbl %>% 
  filter(!is.na(First_dose)) %>% 
  mutate(iso_wk = isoweek(First_dose),
         iso_yr = isoyear(First_dose))

cum_vacc_gavl_entire <- cum_vacc_gavl_entire %>% 
  count(iso_wk, iso_yr) %>% 
  arrange(iso_yr, iso_wk )

cum_vacc_gavl_18_plus <- cum_vacc_gavl_entire %>% 
  mutate(date_Monday = date_in_week(year = iso_yr, week = iso_wk, weekday = 1)) %>% 
  arrange(date_Monday) %>% 
  rename( n_vaxed_per_week = n) %>% 
  mutate( cum_vax = cumsum(n_vaxed_per_week)) %>% 
  mutate(population = pulation_Entire_gavle_18_plus$population) %>% 
  mutate(cum_share = round(cum_vax/population, digits= 3))







```


## Cumulative Number of Vaccinated

### Per Age Group (Birth year 1962-1971 & 1972-1981)

#### Uppsala
```{r cumulative-numbers-plots-agegroup-uppsala, warning = FALSE}


library(tidyverse)
library(readxl)
library(ggstream)
library(showtext)
library(ggtext)
library(hrbrthemes)
library(viridis)
library(RColorBrewer)
library(scales)

library(ggplot2)
cum_vacc_upps_39_59 %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(
    data =  cum_vacc_upps_39_59 %>%
      filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
      mutate(Birth_year_group = fct_recode(Birth_year_group, `1962 - 1971` = '1972 - 1981',
                                           `1972 - 1981` = '1962 - 1971')) %>% 
      as.data.frame(), 
    aes(group = Birth_year_group),
    color = 'gray63',
    size = 0.5, alpha = 0.5) +
  
  
  geom_line(aes(color = Age_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  scale_y_continuous(labels = scales::comma)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Uppsala County (per birth year group)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )+
  facet_wrap(~Birth_year_group)





```

#### Gävle
```{r cumulative-numbers-plots-agegroup-gavle, warning = FALSE}


cum_vacc_gavl_39_59 %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(
    data =  cum_vacc_gavl_39_59 %>%
      filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
      mutate(Birth_year_group = fct_recode(Birth_year_group, `1962 - 1971` = '1972 - 1981',
                                           `1972 - 1981` = '1962 - 1971')) %>% 
      as.data.frame(), 
    aes(group = Birth_year_group),
    color = 'gray63',
    size = 0.5, alpha = 0.5) +
  
  
  geom_line(aes(color = Age_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  scale_y_continuous(labels = scales::comma)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Gävle County (per birth year group)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )+
  facet_wrap(~Birth_year_group)







```


### All Study Participants (Birth year 1962-1981)

#### Uppsala

```{r cumulative-numbers-plots-uppsala, warning = FALSE}

cum_vacc_upps_39_59_both_cohorts %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Uppsala County (all study participants; born between 1962-1981)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::comma)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )

```


#### Gävle

```{r cumulative-numbers-plots-gavle, warning = FALSE}

cum_vacc_gavl_39_59_both_cohorts %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Gävle County (all study participants; born between 1962-1981)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::comma)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```


### Entire Adult Population (18 plus)

#### Uppsala
```{r cumulative-numbers-plots-uppsala-entire, warning = FALSE}

cum_vacc_upps_18_plus %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Uppsala County (entire adult population; born in 2003 or earlier)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::comma)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```


#### Gävle
```{r cumulative-numbers-plots-gavle-entire, warning = FALSE}

cum_vacc_gavl_18_plus %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_vax)) +
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Number of Vaccinated Over Time',
       subtitle = 'Gävle County (entire adult population; born in 2003 or earlier)',
       x = 'Time',
       y = 'Number of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::comma)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```



## Cumulative Share of Vaccinated

### Per Age Group (Birth year 1962-1971 & 1972-1981)

#### Uppsala
```{r cumulative-share-plots-agegroup-uppsala, warning = FALSE}


library(forcats)
unique(cum_vacc_upps_39_59$Birth_year_group)
cum_vacc_upps_39_59 %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  
  
  geom_line(
    data =  cum_vacc_upps_39_59 %>%
      filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
      mutate(Birth_year_group = fct_recode(Birth_year_group, `1962 - 1971` = '1972 - 1981',
                                           `1972 - 1981` = '1962 - 1971')) %>% 
      as.data.frame(), 
    aes(group = Birth_year_group),
    color = 'gray63',
    size = 0.5, alpha = 0.5) +
  
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  scale_y_continuous(labels = scales::percent)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Uppsala County County (per birth year group)',
       
       x = 'Time',
       y = 'Cumulative share(%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )+
  facet_wrap(~Birth_year_group)




```


#### Gävle
```{r cumulative-share-plots-agegroup-gavle, warning = FALSE}



cum_vacc_gavl_39_59 %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  geom_line(
    data =  cum_vacc_gavl_39_59 %>%
      filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
      mutate(Birth_year_group = fct_recode(Birth_year_group, `1962 - 1971` = '1972 - 1981',
                                           `1972 - 1981` = '1962 - 1971')) %>% 
      as.data.frame(), 
    aes(group = Birth_year_group),
    color = 'gray63',
    size = 0.5, alpha = 0.5) +
  
  geom_line(aes(color = Birth_year_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  scale_y_continuous(labels = scales::percent)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Gävle County County (per birth year group)',
       
       x = 'Time',
       y = 'Cumulative share(%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )+
  facet_wrap(~Birth_year_group)




```


### All Study Participants (Birth year 1962-1981)

#### Uppsala


```{r cumulative-share-plots-bothbirthyearcohorts-uppsala, warning = FALSE}




cum_vacc_upps_39_59_both_cohorts %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  
  geom_line(aes(color = Age_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Uppsala County (all study participants; born between 1962-1981)',
       
       x = 'Time',
       y = 'Cumulative share (%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::percent)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```


#### Gävle


```{r cumulative-share-plots-bothbirthyearcohorts-gavle, warning = FALSE}





cum_vacc_gavl_39_59_both_cohorts %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  
  geom_line(aes(color = Age_group), 
            color = '#66abd5', # 9fcae0
            size = 1.1)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Gävle County (all study participants; born between 1962-1981)',
       
       x = 'Time',
       y = 'Cumulative share (%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::percent)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```






### Entire Adult Population (18 plus)

#### Uppsala


```{r cumulative-share-plots-totalpop-uppsala, warning = FALSE}




cum_vacc_upps_18_plus %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  
  geom_line(#aes(color = Age_group), 
    color = '#66abd5', # 9fcae0
    size = 1.1)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Uppsala County (entire adult population; born in 2003 or earlier)',
       
       x = 'Time',
       y = 'Cumulative share (%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::percent)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```


#### Gävle


```{r cumulative-share-plots-totalpop-gavle, warning = FALSE}





cum_vacc_gavl_18_plus %>% 
  filter(date_Monday < as.Date("2021-12-31", format = '%Y-%m-%d')) %>% 
  ggplot(aes(x= date_Monday, 
             y= cum_share)) +
  
  geom_line(#aes(color = Age_group), 
    color = '#66abd5', # 9fcae0
    size = 1.1)+
  
  labs(title = 'Cumulative Share (%) of Vaccinated Over Time',
       subtitle = 'Gävle County (entire adult population; born in 2003 or earlier)',
       
       x = 'Time',
       y = 'Cumulative share (%) of citizens vaccinated') + 
  scale_x_date(date_labels = '%y-%b', date_breaks = '3 month')+
  scale_color_brewer((palette = 'RdBu'))+
  
  
  scale_y_continuous(labels = scales::percent)+
  theme(
    panel.background = element_rect(fill = 'transparent', 
                                    linetype = 1,
                                    color = 'gray85'),
    panel.grid.major.x =  element_line( color = 'gray90',
                                        size = 0.70,
                                        linetype = 2),
    panel.grid.major.y =  element_blank(),
    
    panel.grid.minor = element_blank(),
    
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 60, hjust = 1, size = 10),
    axis.text.y = element_text( size = 10),
    axis.title.x = element_text( size = 14),
    axis.title.y = element_text( size = 14),
    
    legend.position = 'bottom',
    
    panel.spacing = unit(0.3, 'lines'),
    
    
    strip.background = element_blank(),
    strip.text.x = element_text(size = 16),
    plot.title = element_text(size = 16)
  )


```